{% extends 'doctor/doctor_index.html' %}
{% block content %}

<style>
    body {
        background-color: #f0f6ff !important;
        font-family: "Poppins", sans-serif;
    }

    .page-title {
        color: #1D3557;
        font-weight: 800;
        font-size: 2rem;
        margin-bottom: 20px;
        text-align: center;
    }

    .search-box {
        max-width: 450px;
        padding: 10px 18px;
        border-radius: 30px;
        border: 2px solid #457B9D;
        background: white;
    }

    .btn-primary {
        background: linear-gradient(135deg, #457B9D, #3A6682);
        border: none;
        padding: 10px 24px;
        border-radius: 30px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: #004f75;
    }

    .patient-table-container {
        background: #ffffff;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid #d0e7ff;
        box-shadow: 0px 8px 30px rgba(0, 41, 92, 0.12);
        margin-top: 20px;
    }

    table thead th {
        background: linear-gradient(135deg, #3A6682, #457B9D);
        color: #ffffff !important;
        text-align: center;
        padding: 14px;
        font-size: 0.95rem;
        border-bottom: 3px solid #1D3557;
    }

    table tbody td {
        text-align: center;
        padding: 14px;
        background: #ffffff !important;
        border-color: #e2ecf9;
        font-size: 0.95rem;
    }

    table tbody tr:hover td {
        background: #e8f3ff !important;
        cursor: pointer;
    }

    .profile-img {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #457B9D;
        box-shadow: 0 2px 6px rgba(0, 41, 92, 0.25);
    }

    .visit-count {
        color: #1D3557;
        font-weight: 700;
    }

    .btn-history {
        background: linear-gradient(135deg, #457B9D, #3A6682);
        color: white;
        padding: 7px 18px;
        border-radius: 10px;
        font-weight: 600;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 41, 92, 0.15);
    }

    .btn-history:hover {
        background: #004f75;
        transform: translateY(-2px);
    }

    .modal-header {
        background-color: #457B9D;
        border-bottom: 3px solid #1D3557;
    }

    .modal-title {
        font-weight: 700;
        color: white;
    }

    .table-sm th {
        background: #457B9D !important;
        color: white;
    }

    .table-sm td {
        background: white !important;
        font-size: 0.9rem;
        text-align: center;
    }

</style>

<div class="container py-4">

    <h3 class="page-title">Patients — Dr. {{ doctor.name }}</h3>

    <form method="get" class="mb-4 d-flex justify-content-center">
        <input type="text" name="search" value="{{ search_query }}" class="form-control search-box me-2"
               placeholder="Search patient by name, email, or phone...">
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    {% if patient_data %}
    <div class="patient-table-container">
        <table class="table table-bordered align-middle">
            <thead>
                <tr>
                    <th>Profile</th>
                    <th>Patient Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Total Visits</th>
                    <th>History</th>
                </tr>
            </thead>

            <tbody>
                {% for patient, records in patient_data.items %}
                <tr>
                    <td>
                        {% if patient.image %}
                        <img src="{{ patient.image.url }}" class="profile-img">
                        {% else %}
                        <img src="https://cdn-icons-png.flaticon.com/512/2922/2922510.png" class="profile-img">
                        {% endif %}
                    </td>

                    <td>{{ patient.username }}</td>
                    <td>{{ patient.email }}</td>
                    <td>{{ patient.phone }}</td>
                    <td class="visit-count">{{ records|length }}</td>

                    <td>
                        <button class="btn-history" data-bs-toggle="modal"
                                data-bs-target="#historyModal{{ patient.id }}">
                            View History
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center">No Patient found.</div>
    {% endif %}
</div>


<!-- MODALS -->
{% for patient, records in patient_data.items %}
<div class="modal fade" id="historyModal{{ patient.id }}" tabindex="-1" aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">
                    Medical History — {{ patient.username }}
                </h5>
                <button type="button" class="btn-close bg-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                {% for record in records %}
                <div class="border-bottom pb-3 mb-3">

                    <h6>Appointment on {{ record.appointment.date }}</h6>

                    <!-- Correct prescribing doctor -->
                    <p><strong>Doctor:</strong> Dr. {{ record.appointment.doctor.name }}</p>

                    <p><strong>Status:</strong> {{ record.appointment.status|capfirst }}</p>

                    {% if record.prescription %}
                    <p><strong>Symptoms:</strong> {{ record.prescription.symptoms|default:"—" }}</p>
                    <p><strong>Notes:</strong> {{ record.prescription.notes|default:"—" }}</p>

                    {% if record.medicines %}
                    <h6>Medicines</h6>
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Dosage</th>
                                <th>Frequency</th>
                                <th>Time</th>
                                <th>Food</th>
                                <th>Days</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for med in record.medicines %}
                            <tr>
                                <td>{{ med.name }}</td>
                                <td>{{ med.dosage|default:"—" }}</td>
                                <td>{{ med.frequency }}x/day</td>
                                <td>{{ med.time_of_day|join:", " }}</td>
                                <td>{{ med.food_instruction|title }}</td>
                                <td>{{ med.number_of_days }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                    {% endif %}

                </div>
                {% endfor %}

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
